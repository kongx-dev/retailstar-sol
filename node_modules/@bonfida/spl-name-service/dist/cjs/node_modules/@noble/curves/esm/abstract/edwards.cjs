"use strict";var t=require("./curve.cjs"),e=require("./modular.cjs"),n=require("./utils.cjs");
/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */
const r=BigInt(0),i=BigInt(1),s=BigInt(2),o=BigInt(8),a={zip215:!0};exports.twistedEdwards=function(u){const c=function(e){const r=t.validateBasic(e);return n.validateObject(e,{hash:"function",a:"bigint",d:"bigint",randomBytes:"function"},{adjustScalarBytes:"function",domain:"function",uvRatio:"function",mapToCurve:"function"}),Object.freeze({...r})}(u),{Fp:l,n:f,prehash:y,hash:d,randomBytes:h,nByteLength:m,h:p}=c,x=s<<BigInt(8*m)-i,B=l.create,w=e.Field(c.n,c.nBitLength);if(!function(t,e){const n=l.sqr(t),r=l.sqr(e),i=l.add(l.mul(c.a,n),r),s=l.add(l.ONE,l.mul(c.d,l.mul(n,r)));return l.eql(i,s)}(c.Gx,c.Gy))throw new Error("bad curve params: generator point");const E=c.uvRatio||((t,e)=>{try{return{isValid:!0,value:l.sqrt(t*l.inv(e))}}catch(t){return{isValid:!1,value:r}}}),g=c.adjustScalarBytes||(t=>t),b=c.domain||((t,e,r)=>{if(n.abool("phflag",r),e.length||r)throw new Error("Contexts/pre-hash are not supported");return t});function z(t,e,s=!1){const o=s?i:r;n.aInRange("coordinate "+t,e,o,x)}function v(t){if(!(t instanceof A))throw new Error("ExtendedPoint expected")}const R=n.memoized(((t,e)=>{const{ex:n,ey:s,ez:a}=t,u=t.is0();null==e&&(e=u?o:l.inv(a));const c=B(n*e),f=B(s*e),y=B(a*e);if(u)return{x:r,y:i};if(y!==i)throw new Error("invZ was invalid");return{x:c,y:f}})),S=n.memoized((t=>{const{a:e,d:n}=c;if(t.is0())throw new Error("bad point: ZERO");const{ex:r,ey:i,ez:s,et:o}=t,a=B(r*r),u=B(i*i),l=B(s*s),f=B(l*l),y=B(a*e);if(B(l*B(y+u))!==B(f+B(n*B(a*u))))throw new Error("bad point: equation left != right (1)");if(B(r*i)!==B(s*o))throw new Error("bad point: equation left != right (2)");return!0}));class A{constructor(t,e,n,r){z("x",t),z("y",e),z("z",n,!0),z("t",r),this.ex=t,this.ey=e,this.ez=n,this.et=r,Object.freeze(this)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static fromAffine(t){if(t instanceof A)throw new Error("extended point not allowed");const{x:e,y:n}=t||{};return z("x",e),z("y",n),new A(e,n,i,B(e*n))}static normalizeZ(t){const n=e.FpInvertBatch(l,t.map((t=>t.ez)));return t.map(((t,e)=>t.toAffine(n[e]))).map(A.fromAffine)}static msm(e,n){return t.pippenger(A,w,e,n)}_setWindowSize(t){q.setWindowSize(this,t)}assertValidity(){S(this)}equals(t){v(t);const{ex:e,ey:n,ez:r}=this,{ex:i,ey:s,ez:o}=t,a=B(e*o),u=B(i*r),c=B(n*o),l=B(s*r);return a===u&&c===l}is0(){return this.equals(A.ZERO)}negate(){return new A(B(-this.ex),this.ey,this.ez,B(-this.et))}double(){const{a:t}=c,{ex:e,ey:n,ez:r}=this,i=B(e*e),o=B(n*n),a=B(s*B(r*r)),u=B(t*i),l=e+n,f=B(B(l*l)-i-o),y=u+o,d=y-a,h=u-o,m=B(f*d),p=B(y*h),x=B(f*h),w=B(d*y);return new A(m,p,w,x)}add(t){v(t);const{a:e,d:n}=c,{ex:r,ey:i,ez:s,et:o}=this,{ex:a,ey:u,ez:l,et:f}=t,y=B(r*a),d=B(i*u),h=B(o*n*f),m=B(s*l),p=B((r+i)*(a+u)-y-d),x=m-h,w=m+h,E=B(d-e*y),g=B(p*x),b=B(w*E),z=B(p*E),R=B(x*w);return new A(g,b,R,z)}subtract(t){return this.add(t.negate())}wNAF(t){return q.wNAFCached(this,t,A.normalizeZ)}multiply(t){const e=t;n.aInRange("scalar",e,i,f);const{p:r,f:s}=this.wNAF(e);return A.normalizeZ([r,s])[0]}multiplyUnsafe(t,e=A.ZERO){const s=t;return n.aInRange("scalar",s,r,f),s===r?O:this.is0()||s===i?this:q.wNAFCachedUnsafe(this,s,A.normalizeZ,e)}isSmallOrder(){return this.multiplyUnsafe(p).is0()}isTorsionFree(){return q.unsafeLadder(this,f).is0()}toAffine(t){return R(this,t)}clearCofactor(){const{h:t}=c;return t===i?this:this.multiplyUnsafe(t)}static fromHex(t,e=!1){const{d:s,a:o}=c,a=l.BYTES;t=n.ensureBytes("pointHex",t,a),n.abool("zip215",e);const u=t.slice(),f=t[a-1];u[a-1]=-129&f;const y=n.bytesToNumberLE(u),d=e?x:l.ORDER;n.aInRange("pointHex.y",y,r,d);const h=B(y*y),m=B(h-i),p=B(s*h-o);let{isValid:w,value:g}=E(m,p);if(!w)throw new Error("Point.fromHex: invalid y coordinate");const b=(g&i)===i,z=!!(128&f);if(!e&&g===r&&z)throw new Error("Point.fromHex: x=0 and x_0=1");return z!==b&&(g=B(-g)),A.fromAffine({x:g,y:y})}static fromPrivateKey(t){const{scalar:e}=F(t);return T.multiply(e)}toRawBytes(){const{x:t,y:e}=this.toAffine(),r=n.numberToBytesLE(e,l.BYTES);return r[r.length-1]|=t&i?128:0,r}toHex(){return n.bytesToHex(this.toRawBytes())}}A.BASE=new A(c.Gx,c.Gy,i,B(c.Gx*c.Gy)),A.ZERO=new A(r,i,i,r);const{BASE:T,ZERO:O}=A,q=t.wNAF(A,8*m);function I(t){return e.mod(t,f)}function Z(t){return I(n.bytesToNumberLE(t))}function F(t){const e=l.BYTES;t=n.ensureBytes("private key",t,e);const r=n.ensureBytes("hashed private key",d(t),2*e),i=g(r.slice(0,e));return{head:i,prefix:r.slice(e,2*e),scalar:Z(i)}}function H(t){const{head:e,prefix:n,scalar:r}=F(t),i=T.multiply(r),s=i.toRawBytes();return{head:e,prefix:n,scalar:r,point:i,pointBytes:s}}function N(t=Uint8Array.of(),...e){const r=n.concatBytes(...e);return Z(d(b(r,n.ensureBytes("context",t),!!y)))}const j=a;return T._setWindowSize(8),{CURVE:c,getPublicKey:function(t){return H(t).pointBytes},sign:function(t,e,i={}){t=n.ensureBytes("message",t),y&&(t=y(t));const{prefix:s,scalar:o,pointBytes:a}=H(e),u=N(i.context,s,t),c=T.multiply(u).toRawBytes(),d=I(u+N(i.context,c,a,t)*o);n.aInRange("signature.s",d,r,f);const h=n.concatBytes(c,n.numberToBytesLE(d,l.BYTES));return n.ensureBytes("result",h,2*l.BYTES)},verify:function(t,e,r,i=j){const{context:s,zip215:o}=i,a=l.BYTES;t=n.ensureBytes("signature",t,2*a),e=n.ensureBytes("message",e),r=n.ensureBytes("publicKey",r,a),void 0!==o&&n.abool("zip215",o),y&&(e=y(e));const u=n.bytesToNumberLE(t.slice(a,2*a));let c,f,d;try{c=A.fromHex(r,o),f=A.fromHex(t.slice(0,a),o),d=T.multiplyUnsafe(u)}catch(t){return!1}if(!o&&c.isSmallOrder())return!1;const h=N(s,f.toRawBytes(),c.toRawBytes(),e);return f.add(c.multiplyUnsafe(h)).subtract(d).clearCofactor().equals(A.ZERO)},ExtendedPoint:A,utils:{getExtendedPublicKey:H,randomPrivateKey:()=>h(l.BYTES),precompute:(t=8,e=A.BASE)=>(e._setWindowSize(t),e.multiply(BigInt(3)),e)}}};
//# sourceMappingURL=edwards.cjs.map
